<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checklist Personalizado de Biologia</title>
    <!-- Carrega o Tailwind CSS para estiliza√ß√£o -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Bibliotecas para Gerar PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* Fonte Inter (padr√£o do Tailwind) */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        
        /* Estiliza√ß√£o customizada para os bot√µes de r√°dio */
        /* Esconde o input de r√°dio padr√£o */
        input[type="radio"] {
            display: none;
        }

        /* Estilo base do label */
        input[type="radio"] + label {
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            padding: 0.5rem 0.75rem; /* Ajustado para economizar espa√ßo */
            border: 2px solid #e2e8f0; /* cinza-300 */
            border-radius: 9999px; /* full */
            transition: all 0.2s ease-in-out;
            font-weight: 500;
        }

        /* Estilo do label quando o r√°dio est√° checado */
        /* N√≠vel Baixo */
        input[value="pouco"]:checked + label {
            background-color: #fee2e2; /* red-100 */
            border-color: #f87171; /* red-400 */
            color: #b91c1c; /* red-700 */
            font-weight: 600;
        }
        /* N√≠vel M√©dio */
        input[value="medio"]:checked + label {
            background-color: #fef9c3; /* yellow-100 */
            border-color: #facc15; /* yellow-400 */
            color: #a16207; /* yellow-700 */
            font-weight: 600;
        }
        /* N√≠vel Dominado */
        input[value="dominado"]:checked + label {
            background-color: #dcfce7; /* green-100 */
            border-color: #4ade80; /* green-400 */
            color: #15803d; /* green-700 */
            font-weight: 600;
        }

        /* Anima√ß√£o de fade-in para o modal */
        #plan-modal {
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Container Principal -->
    <div class="container max-w-5xl mx-auto p-4 sm:p-8">
        
        <!-- Cabe√ßalho -->
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-blue-700">Checklist Personalizado de Biologia - Mago do PISM</h1>
            <p class="text-lg text-gray-600 mt-2">Avalie seu n√≠vel de conhecimento nas mat√©rias do ENEM para gerar um plano de estudos.</p>
        </header>

        <!-- Se√ß√£o do Checklist -->
        <div id="checklist-section" class="bg-white p-6 sm:p-8 rounded-2xl shadow-xl">
            <!-- O conte√∫do do checklist ser√° injetado aqui pelo JavaScript -->
            <div id="checklist-container">
                <p class="text-center text-gray-500">Carregando t√≥picos...</p>
            </div>

            <!-- Bot√µes de A√ß√£o -->
            <div class="flex flex-col sm:flex-row gap-4 mt-10">
                <button id="view-plan-btn" class="w-full sm:w-1/2 bg-blue-600 text-white py-4 px-6 rounded-lg text-lg font-semibold hover:bg-blue-700 transition-all duration-300 shadow-lg focus:outline-none focus:ring-4 focus:ring-blue-300">
                    Ver Plano de Estudos
                </button>
                <button id="download-pdf-btn" class="w-full sm:w-1/2 bg-green-600 text-white py-4 px-6 rounded-lg text-lg font-semibold hover:bg-green-700 transition-all duration-300 shadow-lg focus:outline-none focus:ring-4 focus:ring-green-300">
                    Gerar PDF do Plano
                </button>
            </div>
        </div>
    </div> <!-- Fim do Container Principal -->

    <!-- Modal do Plano de Estudos (escondido por padr√£o) -->
    <!-- ESTA SE√á√ÉO FOI MOVIDA PARA C√Å (PARA FORA DO SCRIPT) -->
    <div id="plan-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50" style="display: none;">
        
        <!-- Conte√∫do do Modal -->
        <div class="bg-white rounded-2xl shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-hidden flex flex-col">
            
            <!-- Cabe√ßalho do Modal -->
            <div class="flex justify-between items-center p-6 border-b border-gray-200">
                <h2 class="text-2xl font-bold text-blue-700">Plano de estudos - Magos da UERJ</h2>
                <button id="close-modal-btn" class="text-gray-400 hover:text-gray-700 text-3xl font-bold">&times;</button>
            </div>

            <!-- Corpo do Modal (com scroll) -->
            <div id="modal-content-to-print" class="p-6 sm:p-8 overflow-y-auto">
                <!-- Introdu√ß√£o do Plano -->
                <div class="mb-8 p-4 bg-blue-50 border-l-4 border-blue-500 rounded-r-lg">
                    <p class="text-gray-700">
                        Este plano foi gerado com base na sua autoavalia√ß√£o. A estrat√©gia √© focar sua energia onde ela √© mais necess√°ria.
                    </p>
                    <ul class="list-disc list-inside mt-2 space-y-1 text-gray-600">
                        <li><strong>Baixa Compreens√£o:</strong> Foco total. Dedique tempo para rever as aulas e os conceitos fundamentais sobre estes temas.</li>
                        <li><strong>Preciso Revisar:</strong> Foco em pr√°tica. Voc√™ j√° entendeu a base, agora √© hora de fixar com exerc√≠cios.</li>
                        <li><strong>Dominei o Conte√∫do:</strong> √ìtimo trabalho! Estes t√≥picos n√£o exigem revis√£o imediata. Siga em frente!</li>
                    </ul>
                </div>

                <!-- Se√ß√µes do Plano -->
                <div class="space-y-6">
                    <!-- N√≠vel 1: Rever Aulas -->
                    <section id="plan-pouco" class="plan-section">
                        <!-- Conte√∫do injetado pelo JS -->
                    </section>
                    
                    <!-- N√≠vel 2: Fazer Exerc√≠cios -->
                    <section id="plan-medio" class="plan-section">
                        <!-- Conte√∫do injetado pelo JS -->
                    </section>

                    <!-- N√≠vel 3: Dominado -->
                    <section id="plan-dominado" class="plan-section">
                        <!-- Conte√∫do injetado pelo JS -->
                    </section>
                </div>

                <!-- Bot√£o de PDF dentro do Modal -->
                <button id="modal-download-pdf-btn" class="w-full mt-8 bg-green-600 text-white py-3 px-6 rounded-lg text-lg font-semibold hover:bg-green-700 transition-all duration-300 shadow-lg focus:outline-none focus:ring-4 focus:ring-green-300">
                    Baixar este Plano em PDF
                </button>
            </div>
        </div>
    </div>
    <!-- FIM DA SE√á√ÉO MOVIDA -->


    <script>
        // --- Defini√ß√£o dos T√≥picos de Biologia ---
        // (Baseado no conte√∫do program√°tico fornecido anteriormente)
        const topicosBiologia = [
            {
                categoria: "Seres vivos",
                itens: [
                    "Classifica√ß√£o dos seres vivos: sistem√°tica filogen√©tica",
                    "Classifica√ß√£o dos seres vivos: reinos e dom√≠nios",
                    "Evolu√ß√£o: origens da vida e transforma√ß√µes dos seres vivos ao longo do tempo",
                    "Evolu√ß√£o: estrat√©gias adaptativas",
                    "Evolu√ß√£o: mecanismos e teorias evolutivas e de sele√ß√£o",
                    "Evolu√ß√£o: biodiversidade",
                    "Bases da ecologia: ecossistemas e biomas",
                    "Bases da ecologia: fluxo de energia e de mat√©ria na biosfera",
                    "Bases da ecologia: cadeias e teias alimentares",
                    "Bases da ecologia: rela√ß√µes ecol√≥gicas",
                    "Bases da ecologia: ciclos biogeoqu√≠micos",
                    "Bases da ecologia: polui√ß√£o e desequil√≠brio ecol√≥gico"
                ]
            },
            {
                categoria: "V√≠rus, c√©lulas e tecidos",
                itens: [
                    "V√≠rus: estrutura; tipos; reprodu√ß√£o",
                    "C√©lulas procariotas e eucariotas: caracter√≠sticas morfol√≥gicas e funcionais",
                    "C√©lulas: principais componentes qu√≠micos",
                    "C√©lulas: mecanismos e fases da divis√£o celular",
                    "C√©lulas: sistema de biomembranas e mecanismos de transporte",
                    "C√©lulas: organelas",
                    "Bioenerg√©tica: respira√ß√£o celular",
                    "Bioenerg√©tica: fermenta√ß√£o",
                    "Bioenerg√©tica: fotoss√≠ntese",
                    "Bioenerg√©tica: quimioss√≠ntese",
                    "Multicelularidade: classifica√ß√£o, estrutura e fun√ß√µes dos tecidos animais e vegetais",
                    "Multicelularidade: desenvolvimento embrion√°rio dos animais",
                    "Multicelularidade: germina√ß√£o e dorm√™ncia"
                ]
            },
            {
                categoria: "Bases da gen√©tica",
                itens: [
                    "Os √°cidos nucleicos DNA e RNA: estrutura; fun√ß√µes",
                    "Cromossomos e genes: c√≥digo gen√©tico",
                    "Cromossomos e genes: s√≠ntese de prote√≠nas",
                    "Cromossomos e genes: muta√ß√£o e recombina√ß√£o g√™nica",
                    "Engenharia gen√©tica: tecnologia do DNA recombinante",
                    "Engenharia gen√©tica: c√©lulas-tronco",
                    "Hereditariedade: mendelismo e neomendelismo",
                    "Hereditariedade: doen√ßas heredit√°rias",
                    "Hereditariedade: altera√ß√µes no patrim√¥nio gen√©tico"
                ]
            },
            {
                categoria: "Bioqu√≠mica e fisiologia de animais e vegetais",
                itens: [
                    "Metabolismo: estrutura e cin√©tica de enzimas",
                    "Metabolismo: anabolismo e catabolismo de carboidratos, lip√≠dios e prote√≠nas",
                    "Metabolismo: tipos e fun√ß√µes dos horm√¥nios",
                    "Metabolismo: vitaminas",
                    "Processamento dos alimentos: digest√£o; absor√ß√£o e transporte de nutrientes nos animais",
                    "Processamento dos alimentos: capta√ß√£o de macro e micronutrientes pelos vegetais",
                    "Respira√ß√£o: mecanismos; √≥rg√£os e tecidos envolvidos; capta√ß√£o e transporte de gases",
                    "Circula√ß√£o: mecanismos; √≥rg√£os e tecidos envolvidos; transporte da seiva nas plantas",
                    "Excre√ß√£o nos animais: mechanisms; √≥rg√£os e tecidos envolvidos",
                    "Homeostasia: mecanismos termorregulat√≥rios; manuten√ß√£o do pH; osmorregula√ß√£o",
                    "Homeostasia: equil√≠brio hidrossalino e equil√≠brio √°cido-b√°sico",
                    "Sistema nervoso: estrutura; transmiss√£o do impulso nervoso",
                    "Reprodu√ß√£o: tipos de ciclos de vida; gametas e fecunda√ß√£o em animais e vegetais",
                    "O sistema imune animal: anticorpos; processos imunol√≥gicos"
                ]
            },
            {
                categoria: "Sa√∫de e bem-estar do homem",
                itens: [
                    "Doen√ßas infecciosas: agentes causadores; endemias, epidemias e pandemias; profilaxia",
                    "Infec√ß√µes sexualmente transmiss√≠veis (IST): agentes causadores e profilaxia",
                    "Doen√ßas parasit√°rias e carenciais no Brasil: agentes causadores; profilaxia",
                    "Medidas preventivas em sa√∫de p√∫blica: higiene; vacina√ß√£o"
                ]
            }
        ];

        // --- Fun√ß√µes do Aplicativo ---

        /**
         * Renderiza o checklist na p√°gina quando ela carrega.
         */
        function renderChecklist() {
            const container = document.getElementById('checklist-container');
            container.innerHTML = ''; // Limpa o "Carregando..."
            let topicIndex = 0;

            topicosBiologia.forEach((categoria, catIndex) => {
                // Cria o t√≠tulo da categoria
                const categoryTitle = document.createElement('h2');
                categoryTitle.className = 'text-2xl font-bold text-gray-800 mt-8 mb-4 border-b-2 border-blue-200 pb-2';
                categoryTitle.textContent = categoria.categoria;
                container.appendChild(categoryTitle);

                // Cria os itens da categoria
                const itemsContainer = document.createElement('div');
                itemsContainer.className = 'space-y-4';

                categoria.itens.forEach((item) => {
                    const uniqueName = `topic_${topicIndex}`;
                    
                    const itemRow = document.createElement('div');
                    itemRow.className = 'topic-row flex flex-col sm:flex-row justify-between sm:items-center py-4 border-b border-gray-100';
                    // Armazena o nome do t√≥pico para f√°cil acesso ao gerar o plano
                    itemRow.setAttribute('data-topic-name', item);

                    // Nome do t√≥pico
                    const topicName = document.createElement('span');
                    topicName.className = 'text-md text-gray-700 mb-3 sm:mb-0 sm:w-2/5';
                    topicName.textContent = item;
                    itemRow.appendChild(topicName);

                    // Grupo de bot√µes de r√°dio
                    const radioGroup = document.createElement('div');
                    radioGroup.className = 'flex flex-wrap gap-2 sm:gap-4 justify-start sm:justify-end sm:w-3/5';
                    
                    // ESTA SE√á√ÉO FOI CORRIGIDA. O HTML do modal e o innerHTML duplicado foram removidos.
                    radioGroup.innerHTML = `
                        <div>
                            <input type="radio" id="${uniqueName}_pouco" name="${uniqueName}" value="pouco">
                            <label for="${uniqueName}_pouco">üò• Baixa</label>
                        </div>
                        <div>
                            <input type="radio" id="${uniqueName}_medio" name="${uniqueName}" value="medio">
                            <label for="${uniqueName}_medio">ü§î Revisar</label>
                        </div>
                        <div>
                            <input type="radio" id="${uniqueName}_dominado" name="${uniqueName}" value="dominado">
                            <label for="${uniqueName}_dominado">ü•∞ Dominei</label>
                        </div>
                    `;
                    itemRow.appendChild(radioGroup);
                    itemsContainer.appendChild(itemRow);
                    topicIndex++;
                });
                container.appendChild(itemsContainer);
            });
        }

        /**
         * Calcula e popula o plano de estudos no modal (sem exibi-lo).
         */
        function calcularEPopularPlano() {
            const poucoDominio = [];
            const medioDominio = [];
            const dominado = [];

            // Seleciona todos os bot√µes de r√°dio que foram marcados
            const radiosSelecionados = document.querySelectorAll('input[type="radio"]:checked');

            radiosSelecionados.forEach(radio => {
                // Encontra a 'linha' (div.topic-row) pai para pegar o nome do t√≥pico
                const topicRow = radio.closest('.topic-row');
                const topicName = topicRow.dataset.topicName;
                const level = radio.value;

                if (level === 'pouco') {
                    poucoDominio.push(topicName);
                } else if (level === 'medio') {
                    medioDominio.push(topicName);
                } else if (level === 'dominado') {
                    dominado.push(topicName);
                }
            });

            // Popula as se√ß√µes do modal
            populatePlanList(
                document.getElementById('plan-pouco'), 
                'üéØ Foco Total: Rever Aulas', 
                poucoDominio,
                'Nenhum t√≥pico marcado com baixa compreens√£o. Muito bem!'
            );
            populatePlanList(
                document.getElementById('plan-medio'), 
                '‚úçÔ∏è Pr√°tica: Fazer Exerc√≠cios', 
                medioDominio,
                'Nenhum t√≥pico marcado para revis√£o. Continue assim!'
            );
            populatePlanList(
                document.getElementById('plan-dominado'), 
                'üéâ Dominado: Revis√£o Opcional', 
                dominado,
                'Nenhum t√≥pico marcado como dominado ainda. Continue estudando!'
            );

            // Exibe o modal
            // document.getElementById('plan-modal').style.display = 'flex'; // Removido daqui
        }

        /**
         * Fun√ß√£o auxiliar para popular as listas no modal.
         * @param {HTMLElement} container - O elemento da se√ß√£o (ex: #plan-pouco).
         * @param {string} title - O t√≠tulo da se√ß√£o (ex: 'Rever Aulas').
         * @param {string[]} items - Um array de nomes de t√≥picos.
         * @param {string} emptyMessage - Mensagem para exibir se a lista estiver vazia.
         */
        function populatePlanList(container, title, items, emptyMessage) {
            container.innerHTML = ''; // Limpa a se√ß√£o

            // Adiciona o t√≠tulo da se√ß√£o
            const h3 = document.createElement('h3');
            let titleClasses = 'text-xl font-semibold mb-3 ';
            if (title.includes('Foco Total')) titleClasses += 'text-red-600';
            if (title.includes('Pr√°tica')) titleClasses += 'text-yellow-600';
            if (title.includes('Dominado')) titleClasses += 'text-green-600';
            h3.className = titleClasses;
            h3.textContent = title;
            container.appendChild(h3);

            if (items.length > 0) {
                const ul = document.createElement('ul');
                ul.className = 'list-disc list-inside space-y-2 text-gray-700 pl-2';
                items.forEach(item => {
                    const li = document.createElement('li');
                    li.textContent = item;
                    ul.appendChild(li);
                });
                container.appendChild(ul);
            } else {
                // Exibe a mensagem de lista vazia
                const p = document.createElement('p');
                p.className = 'text-gray-500 italic';
                p.textContent = emptyMessage;
                container.appendChild(p);
            }
        }

        /**
         * Fecha o modal do plano de estudos.
         */
        function fecharModal() {
            document.getElementById('plan-modal').style.display = 'none';
        }

        /**
         * Abre o modal do plano de estudos.
         */
        function verPlano() {
            calcularEPopularPlano(); // Popula o conte√∫do
            document.getElementById('plan-modal').style.display = 'flex'; // Mostra o modal
        }

        /**
         * Gera e baixa um PDF do plano de estudos.
         * @param {HTMLElement} btn - O bot√£o que acionou o evento.
         */
        function gerarPDF(btn) {
            const { jsPDF } = window.jspdf;
            const modalContent = document.getElementById('modal-content-to-print');
            const originalBtnText = btn.innerHTML;
            
            // --- CORRE√á√ÉO ---
            // Pega o bot√£o *dentro* do modal para escond√™-lo
            const modalBtnToHide = document.getElementById('modal-download-pdf-btn');
            // --- FIM CORRE√á√ÉO ---

            // Mostrar estado de loading
            btn.innerHTML = 'Gerando...';
            btn.disabled = true;

            // --- CORRE√á√ÉO ---
            // Esconde o bot√£o de download do modal ANTES de capturar a tela
            if (modalBtnToHide) {
                modalBtnToHide.style.display = 'none';
            }
            // --- FIM CORRE√á√ÉO ---

            html2canvas(modalContent, {
                scale: 2 // Melhorar a resolu√ß√£o da imagem
            }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF('p', 'pt', 'a4'); // Retrato, pontos, A4
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = pdf.internal.pageSize.getHeight();
                
                const imgProps = pdf.getImageProperties(imgData);
                const imgWidth = imgProps.width;
                const imgHeight = imgProps.height;
                
                // Calcular a propor√ß√£o para caber na largura do PDF com alguma margem
                const margin = 40; // 20 pontos de cada lado
                const usableWidth = pdfWidth - (margin * 2);
                const ratio = usableWidth / imgWidth;
                const scaledHeight = imgHeight * ratio;
                
                let heightLeft = scaledHeight;
                let position = margin; // Posi√ß√£o Y inicial

                // Adiciona a imagem, lidando com quebra de p√°gina se necess√°rio
                // (Para este conte√∫do, √© prov√°vel que caiba em uma p√°gina, mas a l√≥gica est√° aqui)
                pdf.addImage(imgData, 'PNG', margin, position, usableWidth, scaledHeight);
                heightLeft -= (pdfHeight - (margin * 2));

                while (heightLeft > 0) {
                    pdf.addPage();
                    position = margin - scaledHeight + heightLeft; // Posi√ß√£o Y negativa
                    pdf.addImage(imgData, 'PNG', margin, position, usableWidth, scaledHeight);
                    heightLeft -= (pdfHeight - (margin * 2));
                }
                
                pdf.save('Plano_Estudos_Biologia_Magos_UERJ.pdf');
                
                // --- CORRE√á√ÉO ---
                // Restaura o bot√£o clicado
                btn.innerHTML = originalBtnText;
                btn.disabled = false;
                
                // Mostra o bot√£o de download do modal novamente
                if (modalBtnToHide) {
                    modalBtnToHide.style.display = 'block';
                }
                // --- FIM CORRE√á√ÉO ---

            }).catch(err => {
                console.error("Erro ao gerar PDF:", err);
                alert("Ocorreu um erro ao gerar o PDF."); // Use um modal customizado se preferir
                
                // --- CORRE√á√ÉO ---
                // Restaura o bot√£o clicado (em caso de erro)
                btn.innerHTML = originalBtnText;
                btn.disabled = false;

                // Mostra o bot√£o de download do modal novamente (em caso de erro)
                if (modalBtnToHide) {
                    modalBtnToHide.style.display = 'block';
                }
                // --- FIM CORRE√á√ÉO ---
            });
        }


        // --- Event Listeners ---

        // Renderiza o checklist assim que o DOM estiver pronto
        document.addEventListener('DOMContentLoaded', renderChecklist);

        // A√ß√£o dos novos bot√µes
        document.getElementById('view-plan-btn').addEventListener('click', verPlano);
        
        document.getElementById('download-pdf-btn').addEventListener('click', function() {
            calcularEPopularPlano(); // Popula o conte√∫do primeiro
            gerarPDF(this); // 'this' √© o bot√£o que foi clicado
        });

        document.getElementById('modal-download-pdf-btn').addEventListener('click', function() {
            gerarPDF(this); // 'this' √© o bot√£o que foi clicado
        });


        // A√ß√µes para fechar o modal
        document.getElementById('close-modal-btn').addEventListener('click', fecharModal);
        document.getElementById('plan-modal').addEventListener('click', (event) => {
            // Fecha o modal se o usu√°rio clicar fora do conte√∫do (no overlay)
            if (event.target === event.currentTarget) {
                fecharModal();
            }
        });
    </script>
</body>
</html>
